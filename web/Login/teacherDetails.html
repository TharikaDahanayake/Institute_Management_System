<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Details Form</title>
    <style>
         @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color:#d6d6d6;  
            background-size: cover;
            color: #010048;
        }

        .container {
            width: 60%;
            margin: 50px auto;
            background-color: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            border: 10px solid #010048; /* Dark blue border */
        }

        .header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .header img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-right: 20px;
        }

        .header h1 {
            margin: 0;
            color: #010048;
        }

        form {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-top: 10px;
            font-weight: bold;
            color: #010048;
        }

        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="tel"],
        input[type="password"],
        textarea,
        select {
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            width: 100%; /* Ensures uniform width */
            box-sizing: border-box;
        }


        textarea {
            resize: vertical;
        }

        .scroll-container {
            display: block;
            width: 100%;
            max-height: 600px; /* Increase table height */
            overflow-y: auto;
        }

        .search-bar {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            background-color: #010048;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
        }

        button:hover {
            background-color: #010048;
        }

        button[type="reset"] {
            background-color: #010048;
        }

        button[type="reset"]:hover {
            background-color: #010048;
        }

        .search-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        .search-bar input[type="text"] {
            padding: 10px;
            width: 250px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
        }

        .search-bar button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            background-color: #010048;
            color: #fff;
            cursor: pointer;
        }

        .search-bar button:hover {
            background-color: #010048;
        }

        .search-bar button#searchBtn {
            margin-right: 10px;
        }

        .suggestion-box {
            position: absolute;
            top: 45px;
            left: 0;
            width: 250px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .suggestion-box div {
            padding: 10px;
            cursor: pointer;
        }

        .suggestion-box div:hover {
            background-color: #f4f4f4;
        }

        .password-container {
            position: relative;
            width: 100%;
        }

        .toggle-password {
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="scroll-container">
        <div class="header">
           
            <h1>Teacher Details Form</h1>
        </div>
        

        <!-- Search Bar -->
        <div class="search-bar">
            <input type="text" id="searchTeacherID" placeholder="Enter Teacher ID" autocomplete="off">
            <div id="suggestions" class="suggestion-box"></div>
            <button type="button" id="searchBtn">Search</button>
            <button type="reset" id="clearSearchBtn">Reset</button>
        </div>

        <!-- Teacher Details Form -->
        <form id="teacherForm">
            <label for="teacherID">Teacher ID:</label>
            <input type="text" id="teacherID" name="teacherID" readonly>

            <label for="nic">NIC:</label>
            <input type="text" id="nic" name="nic">

            <label for="fname">First Name:</label>
            <input type="text" id="fname" name="fname">

            <label for="lname">Last Name:</label>
            <input type="text" id="lname" name="lname">

            <label for="age">Age:</label>
            <input type="text" id="age" name="age">

            <label for="gender">Gender:</label>
            <div class="gender-options">
                <input type="radio" id="male" name="gender" value="Male">
                <label for="male">Male</label>
                <input type="radio" id="female" name="gender" value="Female">
                <label for="female">Female</label>
            </div>

            <label for="stream">Stream:</label>
            <select id="stream" name="stream" required>
                <option value="">Select Stream</option>
            </select>

            <label for="subjectName">Subject Name:</label>
            <select id="subjectName" name="subjectName" required>
                <option value="">Select Subject</option>
            </select>

            <label for="address">Address:</label>
            <textarea id="address" name="address"></textarea>

            <label for="email">Email:</label>
            <input type="email" id="email" name="email">

            <label for="telephone">Telephone Number:</label>
            <input type="tel" id="telephone" name="telephone"> 

            <label for="password">Password:</label>
            <div class="password-container">
                <input type="password" id="password" name="password" required>
                <span class="toggle-password">üëÅ</span>
            </div>

            <label for="qualification">Qualification:</label>
            <input type="text" id="qualification" name="qualification">

            <div class="form-buttons">
                <button type="reset">Clear</button>
                <button type="button" id="updateBtn">Update</button>
                
            </div>
        </form>
    </div>
</div>
    <script type="module">
        // Import the necessary functions from the Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import {  getFirestore, collection, updateDoc, doc, query, where, getDocs, orderBy  } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
        apiKey: "AIzaSyAX-suYFhRF6svCQaRXEXIFs2EF4SN_-Ag",
        authDomain: "admin-website-cc58a.firebaseapp.com",
        projectId: "admin-website-cc58a",
        storageBucket: "admin-website-cc58a.appspot.com",
        messagingSenderId: "1038815370367",
        appId: "1:1038815370367:web:27be85a2304aef6056b34a"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let currentDocId = ""; // To keep track of the current document ID
    
        // Function to show suggestions as user types
        document.getElementById('searchTeacherID').addEventListener('input', async function () {
            const searchValue = document.getElementById('searchTeacherID').value;
    
            if (searchValue.length < 4) {
                document.getElementById('suggestions').innerHTML = ''; // Clear suggestions if less than 4 characters
                return;
            }
        
            try {
                const q = query(
                    collection(db, "teachers"),
                    orderBy("teacherID"),
                    startAt(searchValue),
                    endAt(searchValue + "\uf8ff")
                );
                const querySnapshot = await getDocs(q);
    
                let suggestions = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    suggestions += `<div data-teacherid="${data.teacherID}">${data.teacherID}</div>`;
                });
    
                document.getElementById('suggestions').innerHTML = suggestions;
    
                // Click event for suggestions
                const suggestionItems = document.querySelectorAll('.suggestion-box div');
                suggestionItems.forEach(item => {
                    item.addEventListener('click', function () {
                        document.getElementById('searchTeacherID').value = this.getAttribute('data-teacherid');
                        document.getElementById('suggestions').innerHTML = ''; // Clear suggestions
                        loadTeacherDetails(this.getAttribute('data-teacherid'));
                    });
                });
    
            } catch (error) {
                console.error("Error fetching teacher suggestions:", error);
            }
        });
    
        async function loadTeacherDetails(teacherID) {
    const q = query(collection(db, "teachers"), where("teacherID", "==", teacherID));
    const querySnapshot = await getDocs(q);

    if (!querySnapshot.empty) {
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            currentDocId = doc.id; // Save the current document ID

            // Fill the form with the fetched data
            document.getElementById('teacherID').value = data.teacherID || '';
            document.getElementById('nic').value = data.nic || '';
            document.getElementById('fname').value = data.fname || '';
            document.getElementById('lname').value = data.lname || '';
            document.getElementById('age').value = data.age || '';
            document.getElementById(data.gender === 'Male' ? 'male' : 'female').checked = true;

            // Clear and repopulate dropdowns
            document.getElementById('stream').innerHTML = ''; // Clear previous options
            document.getElementById('subjectName').innerHTML = ''; // Clear previous options
            
            // Populate streams and subjects (if necessary)
            populateDropdowns();

            // Set the values based on fetched data
            document.getElementById('stream').value = data.stream || '';
            document.getElementById('subjectName').value = data.subjectName || '';
            document.getElementById('address').value = data.address || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('telephone').value = data.telephone || '';
            document.getElementById('password').value = data.password || '';
            document.getElementById('qualification').value = data.qualification || '';
        });
    } else {
        alert("No teacher found with the given ID.");
    }
}

        // Event listener for the Search button
        document.getElementById('searchBtn').addEventListener('click', function () {
            const teacherID = document.getElementById('searchTeacherID').value.trim();
            if (teacherID) {
                loadTeacherDetails(teacherID);
            } else {
                alert("Please enter a Teacher ID to search.");
            }
        });
    

        // Toggle password visibility
        const togglePassword = document.querySelector(".toggle-password");
        const passwordInput = document.getElementById("password");
        togglePassword.addEventListener("click", function() {
            if (passwordInput.type === "password") {
                passwordInput.type = "text";
            } else {
                passwordInput.type = "password";
            }
        });

        // Event listener for the Reset button
        document.getElementById('clearSearchBtn').addEventListener('click', function () {
            document.getElementById('searchTeacherID').value = '';
            document.getElementById('suggestions').innerHTML = '';
            document.getElementById('teacherForm').reset();
            currentDocId = ''; // Reset the current document ID
        });
    
        // Event listener for the Update button
        document.getElementById('updateBtn').addEventListener('click', async function () {
            if (!currentDocId) {
                alert("Please search and select a teacher to update.");
                return;
            }
    
            // Validation: Check for empty fields
            const teacherID = document.getElementById('teacherID').value.trim();
            const nic = document.getElementById('nic').value.trim();
            const fname = document.getElementById('fname').value.trim();
            const lname = document.getElementById('lname').value.trim();
            const age = document.getElementById('age').value.trim();
            const gender = document.querySelector('input[name="gender"]:checked')?.value || '';
            const stream = document.getElementById('stream').value.trim();
            const subjectName = document.getElementById('subjectName').value.trim();
            const address = document.getElementById('address').value.trim();
            const email = document.getElementById('email').value.trim();
            const telephone = document.getElementById('telephone').value.trim();
            const password = document.getElementById('password').value.trim();
            const qualification = document.getElementById('qualification').value.trim();
    
            if (!teacherID || !nic || !fname || !lname || !age || !gender || !stream || !subjectName || !address || !email || !telephone || !password || !qualification) {
                alert("All fields are required. Please fill in all fields before updating.");
                return;
            }
               
            

            if (!await isSubjectValidForStream(subjectName, stream)) {
        alert("The selected subject does not match the selected stream.");
        return;
    }

    const nameRegex = /^[A-Za-z]+$/;

        // Validate student's first name
        if (!nameRegex.test(fname)) {
        alert('Please enter a valid first name for teacher!');
        return false;
        }

        // Validate student's last name
        if (!nameRegex.test(lname)) {
        alert('Please enter a valid last name for teacher!');
        return false;
        }
            
            if (!validateEmail(email)) {
            alert("Please enter a valid email address that starts with a letter and ends with @gmail.com!");
            return;
        }

            // Check if the phone number matches the regex pattern
            if (!validateTelephone(telephone)) {
                alert("Please enter a valid phone number !");
                return;
            }

            
    if (!validateAge(age)) {
    alert("Please enter a valid age between 25 and 65.");
    return;
    }

            // Password validation
            if (!validatePassword(password)) {
                alert("Password must contain at least 8 characters, one uppercase letter, one lowercase letter, one number, and one special character.");
                return;
            }

            const updatedData = {
                teacherID,
                nic,
                fname,
                lname,
                age,
                gender,
                stream,
                subjectName,
                address,
                email,
                telephone,
                password,
                qualification
            };
    
            try {
                const teacherDoc = doc(db, "teachers", currentDocId);
                await updateDoc(teacherDoc, updatedData);
                alert("Teacher details updated successfully.");
            } catch (error) {
                console.error("Error updating teacher details:", error);
                alert("Failed to update teacher details.");
            }
        });


        function validateTelephone(telephone) {
    // Regular expression to check if the input contains exactly 10 digits
    const telephonePattern = /^\d{10}$/;
    return telephonePattern.test(telephone);
        }

    
    
        // Password validation function
        function validatePassword(password) {
            const passwordPattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
            return passwordPattern.test(password);
        }

              // Email validation function
              function validateEmail(email) {
            const emailPattern = /^[a-zA-Z][a-zA-Z0-9._%+-]*@gmail\.com$/;
            return emailPattern.test(email);
        }
    

               // Function to validate if the selected subject matches the selected stream
async function isSubjectValidForStream(subjectName, stream) {
    try {
        const subjectsRef = collection(db, "subjects");
        const q = query(subjectsRef, where("Stream", "==", stream), where("SubjectName", "==", subjectName));
        const querySnapshot = await getDocs(q);

        // If the query returns results, it means the subject matches the stream
        return !querySnapshot.empty;
    } catch (error) {
        console.error("Error validating subject and stream: ", error);
        return false;
    }
}

        // Fetch and populate streams and subjects from Firestore
        async function populateDropdowns() {
            const streamSelect = document.getElementById("stream");
            const subjectSelect = document.getElementById("subjectName");
    
            try {
                // Fetch subjects collection
                const subjectsSnapshot = await getDocs(collection(db, "subjects"));
    
                // Create sets to avoid duplicate stream entries
                const streamsSet = new Set();
    
                subjectsSnapshot.forEach(doc => {
                    const data = doc.data();
    
                    // Add unique stream names to the set
                    if (data.Stream) {
                        streamsSet.add(data.Stream);
                    }
    
                    // Add subject names to the subject dropdown
                    if (data.SubjectName) {
                        const subjectOption = document.createElement("option");
                        subjectOption.value = data.SubjectName;
                        subjectOption.textContent = data.SubjectName;
                        subjectSelect.appendChild(subjectOption);
                    }
                });
    
                // Populate the stream dropdown from the streams set
                streamsSet.forEach(stream => {
                    const streamOption = document.createElement("option");
                    streamOption.value = stream;
                    streamOption.textContent = stream;
                    streamSelect.appendChild(streamOption);
                });
    
            } catch (error) {
                console.error("Error fetching streams and subjects: ", error);
            }
        }

                // Age validation function
function validateAge(age) {
    const agePattern = /^[1-9][0-9]?$/; // Matches ages from 1 to 99
    if (!agePattern.test(age)) {
        return false; // Age must be a valid number
    }

    const ageValue = parseInt(age, 10);
    return ageValue >= 25 && ageValue <= 65; // Age must be between 18 and 100
}
      
    
        // Call function to populate streams and subjects
        populateDropdowns();
    </script>
    
</body>
</html>